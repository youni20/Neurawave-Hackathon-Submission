openapi: 3.0.3
info:
  title: Relief Ahead - Records API
  version: "1.0.0"
  description: |
    API for creating, listing, updating and deleting user records (migraine/stress entries).
    This OpenAPI document is derived from `api-lambda/relief-ahead-records/lambda_function.py`.
servers:
  - url: http://localhost:8000
    description: Local development server (Flask/SAM)

paths:
  /records:
    get:
      summary: List records for the authenticated user
      parameters:
        - in: header
          name: X-User-ID
          schema:
            type: string
          required: false
          description: "User id; local server accepts X-User-ID header. In production use Authorization/JWT."
        - in: query
          name: start
          schema:
            type: string
          required: false
          description: "Start time for query. Accepts ISO datetime or epoch string as accepted by the service (see get_start_time)."
        - in: query
          name: stop
          schema:
            type: string
          required: false
          description: "Stop time for query. Accepts ISO datetime or epoch string as accepted by the service (see get_stop_time)."
      responses:
        '200':
          description: OK - list of records
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Record'
        '204':
          description: No content - no records in range
    post:
      summary: Create a new record for the authenticated user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RecordCreate'
            example:
              id: "b6a7f0f0-1234-4f6d-9c2b-0a1b2c3d4e5f"
              migraine_level: 2.5
              stress_level: 4.0
              had_trigger_food: true
              had_medication: false
              physical_activity_duration: 30
              sleep_duration: 420
              had_premonition: false
              record_time: "2025-11-17T08:35:00Z"
      parameters:
        - in: header
          name: X-User-ID
          schema:
            type: string
          required: false
          description: Local header for user id. In production use Authorization/JWT.
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
        '400':
          description: Bad request (validation error)
        '500':
          description: Server error

  /records/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
        description: UUID of the record
    get:
      summary: Get a single record by id
      parameters:
        - in: header
          name: X-User-ID
          schema:
            type: string
          required: false
          description: Local header for user id. In production use Authorization/JWT.
      responses:
        '200':
          description: OK - record found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Record'
        '404':
          description: Not found
        '500':
          description: Server error
    put:
      summary: Update an existing record
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RecordCreate'
      parameters:
        - in: header
          name: X-User-ID
          schema:
            type: string
          required: false
          description: Local header for user id. In production use Authorization/JWT.
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
        '400':
          description: Bad request / validation error
        '422':
          description: Unprocessable Entity (time mismatch or delete failed)
        '500':
          description: Server error
    delete:
      summary: Delete a record by id
      parameters:
        - in: header
          name: X-User-ID
          schema:
            type: string
          required: false
          description: Local header for user id. In production use Authorization/JWT.
      responses:
        '204':
          description: Deleted successfully
        '404':
          description: Not found
        '500':
          description: Server error

components:
  schemas:
    RecordCreate:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Optional uuid for the record. The server uses this as tag `id`.
        migraine_level:
          type: number
          format: float
        stress_level:
          type: number
          format: float
        had_trigger_food:
          type: boolean
        had_medication:
          type: boolean
        physical_activity_duration:
          type: integer
          description: Duration in minutes
        sleep_duration:
          type: integer
          description: Duration in minutes
        had_premonition:
          type: boolean
        record_time:
          type: string
          format: date-time
          description: UTC timestamp for the record (used as InfluxDB time)
      required:
        - record_time
    Record:
      allOf:
        - $ref: '#/components/schemas/RecordCreate'
        - type: object
          properties:
            userid:
              type: string
              description: User id of the owner (tag)
            record_time:
              type: string
              format: date-time
            id:
              type: string
              format: uuid

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

security:
  - bearerAuth: []

x-notes: |
  Assumptions and notes:
    - The service extracts the user id from the request (local server uses header X-User-ID; production uses JWT claims).
    - `start` and `stop` query parameters accept values compatible with the project's `get_start_time`/`get_stop_time` helpers (ISO datetimes or time offsets).
    - The API stores data in InfluxDB measurement defined in configuration.
    - The Record response flattens InfluxDB pivoted fields; actual field names are used as in the code.
